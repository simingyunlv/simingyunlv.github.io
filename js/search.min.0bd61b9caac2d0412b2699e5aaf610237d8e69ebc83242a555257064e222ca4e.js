(function(){const s=window.SIMING&&SIMING.indexPath||document.querySelector('meta[name="search-index-path"]')?.content||"/index.zh.json";function o(e){return/^[\x00-\x7F]+$/.test(e)}function e(e){return(e||"").toLowerCase()}function t(e){return window.Pinyin&&typeof window.Pinyin.convertToPinyin=="function"?window.Pinyin.convertToPinyin(e," ",!0):window.tinyPinyin&&tinyPinyin.convertToPinyin?tinyPinyin.convertToPinyin(e," "):e}async function i(){const e=await fetch(s,{credentials:"same-origin"});return await e.json()}function a(n,s){const a=e(s),r=[n.title,n.author,(n.tags||[]).join(" "),n.summary,n.content];let i=!1;if(o(a)){const o=e(t(n.title)).replace(/\s+/g,""),c=e(t(n.author)).replace(/\s+/g,""),l=e(t((n.tags||[]).join(" "))).replace(/\s+/g,""),s=a.replace(/\s+/g,"");i=o.includes(s)||c.includes(s)||l.includes(s),i||(i=r.some(t=>e(t).includes(a)))}else i=r.some(t=>e(t).includes(a));return i}function r(e){return(e||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}function c(e,t){t=t||4;let n=e.summary&&e.summary.trim()?e.summary:e.content||"";n=n.replace(/\[poem\]([\s\S]*?)\[\/poem\]/i,"$1"),n=n.replace(/```poem\s*([\s\S]*?)\s*```/i,"$1");const i=n.replace(/\r\n?/g,`
`).split(`
`),s=[];for(let e=0;e<i.length&&s.length<t;e++){const n=i[e].trimEnd();n.length===0?s.push(""):s.push(n)}const c=i.filter(e=>e.trim().length>0).length,l=c>t,r=document.createDocumentFragment(),o=document.createElement("div");o.className="embedded-poem";const a=document.createElement("div");if(a.className="poem-text",s.forEach(e=>{const t=document.createElement("p");t.className="poem-line",t.textContent=e||" ",a.appendChild(t)}),o.appendChild(a),l){const t=document.createElement("div");t.className="meta";const n=document.createElement("a");n.className="embedded-link",n.href=e.permalink,n.textContent="查看全文",t.appendChild(document.createTextNode("… ")),t.appendChild(n),o.appendChild(t)}return r.appendChild(o),r}function n(e){const t=document.getElementById("results"),n=document.getElementById("search-stats");t.innerHTML="",e.forEach(e=>{const n=document.createElement("li"),s=document.createElement("a");s.href=e.permalink,s.innerHTML=`<strong>${r(e.title||"")}</strong>`,n.appendChild(s),n.appendChild(document.createElement("br"));const o=document.createElement("small");if(o.textContent=`${e.section||""} · ${e.date||""} · ${e.author||""}`,n.appendChild(o),n.appendChild(document.createElement("br")),e.section==="poems"||e.section==="friends")n.appendChild(c(e,4));else{const t=document.createElement("span"),s=(e.summary||e.content||"").replace(/\[poem\][\s\S]*?\[\/poem\]/ig,"");t.textContent=s.substring(0,160),n.appendChild(t)}t.appendChild(n)}),n.textContent=`共 ${e.length} 条结果`}function l(){const e=new URLSearchParams(location.search);return e.get("q")||""}document.addEventListener("DOMContentLoaded",async()=>{const o=await i(),r=document.getElementById("search-form"),e=document.getElementById("q"),t=l();t&&(e.value=t);const s=()=>{const t=e.value.trim();if(!t){n([]);return}const s=o.filter(e=>a(e,t)).slice(0,50);n(s)};r?.addEventListener("submit",e=>{e.preventDefault(),s()}),e?.addEventListener("input",()=>{e.value.length>=1?s():n([])}),t&&s()})})()